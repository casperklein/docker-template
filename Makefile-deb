# all targets are phony (no files to check)
.PHONY: default build clean install uninstall

SHELL := /bin/bash

VERSION := $(shell jq -er '.version' < config.json)
TAG := $(shell jq -er '"\(.image):\(.version)"' < config.json)
APP := $(shell jq -er '.name' < config.json | grep -oP '(?<=docker-).+?(?=-builder)')

ARCH := ${shell			\
	MACHINE=$$(uname -m);	\
	case "$$MACHINE" in	\
        x86_64)			\
                echo "amd64"	\
                ;;		\
        aarch64)		\
                echo "arm64"	\
                ;;		\
        *)			\
                echo "armhf"	\
                ;;		\
        esac			\
}

default: build

build:
	@./build-deb.sh "$(debian)"

clean:
	rm -f "$(APP)_$(VERSION)"-1_*.deb
	docker rmi "$(TAG)"

install:
	dpkg -i "$(APP)_$(VERSION)"-1_$(ARCH).deb

uninstall:
	apt-get purge "$(APP)"
